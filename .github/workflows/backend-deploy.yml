name: Backend Deploy
on:
  push:
    branches:
      - master
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.BACKEND_SSH_KEY }}
      
      - name: Setup Node.js & PM2 on Server
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@18.221.228.203 << 'EOF'
            echo "ðŸ“¥ Installing Node.js..."
            if ! command -v node > /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            echo "ðŸ“¦ Installing PM2 globally..."
            if ! command -v pm2 > /dev/null; then
              sudo npm install -g pm2
            fi
            echo "ðŸ”§ Setting up PM2 startup..."
            pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            echo "âœ… Verifying installation..."
            node --version
            npm --version
            pm2 --version
          EOF
      
      - name: Deploy to EC2 Backend
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@18.221.228.203 << 'EOF'
            echo "ðŸ“ Navigating to backend directory..."
            cd ~/backend
            echo "ðŸ”„ Pulling latest changes..."
            git reset --hard
            git pull origin master
            echo "ðŸ“¦ Installing dependencies..."
            npm install --production
            echo "ðŸ”¨ Building the project..."
            if grep -q '"build"' package.json; then
              npm run build
            else
              echo "No build script found, skipping build step."
            fi
            echo "ðŸš€ Restarting application with PM2..."
            if [ -f ecosystem.config.js ]; then
              pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js
            elif pm2 list | grep -q "uptime-kuma"; then
              pm2 restart uptime-kuma
            else
              echo "Starting new PM2 process..."
              pm2 start ecosystem.config.js
            fi
            echo "ðŸ’¾ Saving PM2 process list..."
            pm2 save
            echo "âœ… Deployment completed successfully!"
            pm2 status
          EOF
